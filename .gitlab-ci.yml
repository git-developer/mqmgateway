include:
  remote: "https://github.com/git-developer/docker-support/raw/v3.3.2/gitlab-ci/docker-template.yml"

variables:
  IMAGE_PLATFORMS: 'linux/amd64,linux/i386,linux/arm64,linux/arm/v7,linux/arm/v6'
  UPDATE_CHECK_URLS: 'https://github.com/git-developer/mqmgateway.git'
  UPDATE_CHECK_REF: 'feature/stdconv'
  BUILD_ARGS: 'REPO_URL=https://github.com/git-developer/mqmgateway REPO_BRANCH=feature/stdconv'

read_application_tags:
  extends: .docker_support:.with_bare_image
  stage: post_build
  artifacts:
    paths:
    - tags
    - labels
  script:
  - set -euo pipefail
  - run() { docker run --rm --entrypoint /bin/sh "${IMAGE_NAME}:${BUILD_CACHE}" -c "${@}"; }

  - COMMIT_DATE="$(run '[ ! -r /opt/metadata/commit_date ] || cut -d " " -f 1 </opt/metadata/commit_date')"
  - COMMIT_SHORT_SHA="$(run '[ ! -r /opt/metadata/commit_short_sha ] || cat /opt/metadata/commit_short_sha')"
  - COMMIT_REF_SLUG="$(run '[ ! -r /opt/metadata/commit_ref_name ] || </opt/metadata/commit_ref_name sed "s/[^a-zA-Z0-9]/-/g"')"
  - BUILD_ID="$(date -u +%Y%m%d_%H%M%S)-${IMAGE_REVISION:-${CI_COMMIT_SHORT_SHA}}-$(od -An -N5 -tu4 </dev/urandom | tr -d ' ' | head -c8)"

  - mkdir -p tags
  - echo >tags/build_id "${IMAGE_NAME}:b${BUILD_ID}"
  - echo >tags/commit_ref_slug "${IMAGE_NAME}:${COMMIT_REF_SLUG}"
  - |
    if [ "${COMMIT_DATE}" ]; then
      APP_VERSION="${COMMIT_REF_SLUG}.${COMMIT_DATE}.${COMMIT_SHORT_SHA}"
      echo >tags/commit_info "${IMAGE_NAME}:${APP_VERSION}"
      mkdir -p labels
      echo >labels/org.opencontainers.image.version "org.opencontainers.image.version=${APP_VERSION}"
    fi
